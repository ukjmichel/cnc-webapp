<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/products"></ion-back-button>
    </ion-buttons>
    <ion-title>New Product</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="onReset()" [disabled]="isSubmitting()">
        <ion-icon name="refresh" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="new-product-page">

    <!-- Success Message -->
    <ion-card *ngIf="success()" color="success" class="success-card">
      <ion-card-content>
        <div class="success-content">
          <ion-icon name="checkmark-circle" class="success-icon"></ion-icon>
          <div>
            <h3>Product Created Successfully!</h3>
            <p>Redirecting to products list...</p>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Error Message -->
    <ion-card *ngIf="error()" color="danger" class="error-card">
      <ion-card-content>
        <div class="error-content">
          <ion-icon name="alert-circle" class="error-icon"></ion-icon>
          <div>
            <h3>Error</h3>
            <p>{{ error() }}</p>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Barcode Scanner Section -->
    <ion-card class="form-card barcode-card">
      <ion-card-header>
        <ion-card-subtitle>
          <ion-icon name="barcode-outline"></ion-icon>
          Barcode Lookup
        </ion-card-subtitle>
        <ion-card-title>Scan or Enter Barcode</ion-card-title>
      </ion-card-header>
      <ion-card-content>

        <!-- Barcode Success Message -->
        <ion-note *ngIf="barcodeSuccess()" color="success" class="barcode-message">
          <ion-icon name="checkmark-circle"></ion-icon>
          {{ barcodeSuccess() }}
        </ion-note>

        <!-- Barcode Error Message -->
        <ion-note *ngIf="barcodeError()" color="danger" class="barcode-message">
          <ion-icon name="alert-circle"></ion-icon>
          {{ barcodeError() }}
        </ion-note>

        <!-- Barcode Input -->
        <div class="barcode-input-group">
          <ion-item>
            <ion-label position="stacked">Barcode (UPC/EAN/GTIN)</ion-label>
            <ion-input
              type="text"
              placeholder="e.g., 012345678905"
              [value]="barcodeInput()"
              (ionInput)="barcodeInput.set($any($event.target).value)"
              [clearInput]="true"
              [disabled]="isLookingUpBarcode()"
            ></ion-input>
            <ion-note slot="helper">
              Enter a barcode to automatically fill product information
            </ion-note>
          </ion-item>

          <!-- Barcode Action Buttons -->
          <div class="barcode-actions">
            <ion-button
              expand="block"
              color="secondary"
              (click)="onBarcodeLookup()"
              [disabled]="isLookingUpBarcode() || !barcodeInput()"
            >
              <ion-icon name="search" slot="start"></ion-icon>
              {{ isLookingUpBarcode() ? 'Looking up...' : 'Lookup Barcode' }}
              <ion-spinner *ngIf="isLookingUpBarcode()" slot="end" name="crescent"></ion-spinner>
            </ion-button>

            <ion-button
              fill="clear"
              color="medium"
              (click)="onClearBarcode()"
              [disabled]="isLookingUpBarcode()"
            >
              <ion-icon name="close-circle" slot="start"></ion-icon>
              Clear
            </ion-button>
          </div>
        </div>

        <ion-note class="barcode-info">
          <ion-icon name="information-circle-outline"></ion-icon>
          If the product exists in our database, it will be shown instead of prefilling the form.
          Otherwise, available information will be filled automatically.
        </ion-note>

      </ion-card-content>
    </ion-card>

    <!-- Form -->
    <form [formGroup]="productForm" (ngSubmit)="onSubmit()">

      <!-- Product ID (Required) -->
      <ion-card class="form-card">
        <ion-card-header>
          <ion-card-subtitle>Required Information</ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>
          
          <ion-item [class.ion-invalid]="hasError('productId')" [class.ion-touched]="productForm.get('productId')?.touched">
            <ion-label position="stacked">
              Product ID <ion-text color="danger">*</ion-text>
            </ion-label>
            <ion-input
              formControlName="productId"
              type="text"
              placeholder="e.g., EAN:123456789"
              [clearInput]="true"
            ></ion-input>
            <ion-note slot="helper">Unique identifier (e.g., EAN, UPC, SKU)</ion-note>
            <ion-note slot="error" *ngIf="hasError('productId')">
              {{ getErrorMessage('productId') }}
            </ion-note>
          </ion-item>

          <ion-item [class.ion-invalid]="hasError('productName')" [class.ion-touched]="productForm.get('productName')?.touched">
            <ion-label position="stacked">
              Product Name <ion-text color="danger">*</ion-text>
            </ion-label>
            <ion-input
              formControlName="productName"
              type="text"
              placeholder="e.g., Sparkling Water"
              [clearInput]="true"
            ></ion-input>
            <ion-note slot="error" *ngIf="hasError('productName')">
              {{ getErrorMessage('productName') }}
            </ion-note>
          </ion-item>

        </ion-card-content>
      </ion-card>

      <!-- Optional Details -->
      <ion-card class="form-card">
        <ion-card-header>
          <ion-card-subtitle>Optional Details</ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>

          <ion-item>
            <ion-label position="stacked">Product Code</ion-label>
            <ion-input
              formControlName="productCode"
              type="text"
              placeholder="e.g., ABC-123"
              [clearInput]="true"
            ></ion-input>
            <ion-note slot="helper">Internal product code or SKU</ion-note>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Brand</ion-label>
            <ion-input
              formControlName="brands"
              type="text"
              placeholder="e.g., Acme Corporation"
              [clearInput]="true"
            ></ion-input>
          </ion-item>

        </ion-card-content>
      </ion-card>

      <!-- Quantity Information -->
      <ion-card class="form-card">
        <ion-card-header>
          <ion-card-subtitle>Quantity Information</ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>

          <div class="quantity-group">
            <ion-item [class.ion-invalid]="hasError('quantity')" [class.ion-touched]="productForm.get('quantity')?.touched">
              <ion-label position="stacked">Quantity</ion-label>
              <ion-input
                formControlName="quantity"
                type="number"
                placeholder="e.g., 6"
                min="0"
              ></ion-input>
              <ion-note slot="error" *ngIf="hasError('quantity')">
                {{ getErrorMessage('quantity') }}
              </ion-note>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Unit</ion-label>
              <ion-input
                formControlName="quantityUnit"
                type="text"
                placeholder="e.g., bottles, boxes, kg"
                [clearInput]="true"
              ></ion-input>
            </ion-item>
          </div>

          <ion-note class="quantity-note">
            <ion-icon name="information-circle-outline"></ion-icon>
            Specify the quantity and unit (e.g., "6 bottles", "1 box", "500 grams")
          </ion-note>

        </ion-card-content>
      </ion-card>

      <!-- Description -->
      <ion-card class="form-card">
        <ion-card-header>
          <ion-card-subtitle>Additional Information</ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>

          <ion-item [class.ion-invalid]="hasError('description')" [class.ion-touched]="productForm.get('description')?.touched">
            <ion-label position="stacked">Description</ion-label>
            <ion-textarea
              formControlName="description"
              rows="4"
              placeholder="Enter product description, features, or additional notes..."
              [counter]="true"
              maxlength="500"
            ></ion-textarea>
            <ion-note slot="error" *ngIf="hasError('description')">
              {{ getErrorMessage('description') }}
            </ion-note>
          </ion-item>

        </ion-card-content>
      </ion-card>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <ion-button
          expand="block"
          color="primary"
          type="submit"
          [disabled]="isSubmitting() || success()"
        >
          <ion-icon name="save" slot="start"></ion-icon>
          {{ isSubmitting() ? 'Creating...' : 'Create Product' }}
          <ion-spinner *ngIf="isSubmitting()" slot="end" name="crescent"></ion-spinner>
        </ion-button>

        <ion-button
          expand="block"
          fill="outline"
          color="medium"
          (click)="onCancel()"
          [disabled]="isSubmitting()"
        >
          <ion-icon name="close" slot="start"></ion-icon>
          Cancel
        </ion-button>
      </div>

    </form>

    <!-- Helper Text -->
    <div class="helper-section">
      <ion-note>
        <ion-icon name="shield-checkmark-outline"></ion-icon>
        <strong>Note:</strong> Fields marked with <ion-text color="danger">*</ion-text> are required.
        You must have employee or admin privileges to create products.
      </ion-note>
    </div>

  </div>
</ion-content>